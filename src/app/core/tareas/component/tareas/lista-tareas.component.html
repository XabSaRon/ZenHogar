@if (tareasParaValorar$ | async; as porValorar) {
@if ((porValorar?.length ?? 0) > 0) {
<div class="aviso-valoracion">
  ğŸ”” Tienes {{ porValorar.length }} tarea{{ porValorar.length > 1 ? 's' : '' }}
  pendiente{{ porValorar.length > 1 ? 's' : '' }} de valorar
</div>
}
}

@if (isGuest$ | async) {
@if (miembros$ | async; as miembros) {
<div class="fila-header">
  <div class="info-usuario saludo-card">
    <span class="emoji">ğŸ‘‹</span>
    <span class="texto-bienvenida">Bienvenido a ZenHogar</span>
    <span class="pipe">|</span>
    <span class="muted"> â€” Este es un hogar de ejemplo para que veas cÃ³mo funciona.</span>
  </div>

  <div class="selector-filtro">
    <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
      <span class="icono-texto">
        <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
      </span>
      <span class="chevron">â–¾</span>
    </button>

    @if (mostrarFiltroEstado) {
    <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorEstado('todos')">ğŸ—‚ï¸ Todas las tarjetas</div>
      <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">ğŸ”“ Sin asignar</div>
      <div class="opcion" (click)="filtrarPorEstado('en_curso')">â³ En curso</div>
      <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">â­ Pendiente valoraciÃ³n</div>
    </div>
    }
  </div>

  <div class="selector-filtro">
    <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
      @if (uidSeleccionadoNombre) {
      <span class="icono-texto">
        @if (uidSeleccionadoFoto) {
        <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
        }
        {{ uidSeleccionadoNombre }}
      </span>
      } @else {
      <span class="icono-texto"><span class="emoji-icon">ğŸ‘¥</span> Todos</span>
      }
      <span class="chevron">â–¾</span>
    </button>

    @if (mostrarFiltro) {
    <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorUsuario(null)">ğŸ‘¥ Todos</div>
      @for (miembro of miembros; track miembro.uid) {
      <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
        @if (miembro.fotoURL) {
        <img [src]="miembro.fotoURL" alt="avatar" />
        }
        {{ miembro.nombre }}
      </div>
      }
    </div>
    }
  </div>
</div>

<div class="contenedor-tareas">
  <div class="grid-tareas">
    @if (tareas$ | async; as tareasDemo) {
    @for (tarea of tareasDemo; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="'guest'" [miembros]="miembros" [delay]="i"
      (asignadoCambio)="invitaALogin()" (tareaCompletada)="invitaALogin()">
    </app-tarjeta-tarea>
    }
    }
  </div>
</div>
}
}
@else {
@if (usuario$ | async; as usuario) {
@if (tareas$ | async; as tareas) {
<div class="fila-header">

  <div class="info-usuario saludo-card">
    <span class="emoji">ğŸ‘‹</span>
    <span class="texto-bienvenida">Hola {{ usuario.displayName || usuario.email }}</span>

    @if (tareasAsignadas$ | async; as asignadas) {
    <span class="pipe">|</span>
    <span class="resumen-tareas">
      ğŸ§¹ {{ asignadas.length }}
      <span class="muted">
        tarea{{ asignadas.length === 1 ? '' : 's' }}
        asignada{{ asignadas.length === 1 ? '' : 's' }}
      </span>
    </span>
    }

    <span class="pipe">|</span>
    <span class="badge-puntos">
      â­ <strong>{{ (puntosSemana$ | async) ?? 0 }}</strong> esta semana
    </span>
  </div>

  <div class="selector-filtro">
    <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
      <span class="icono-texto">
        <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
      </span>
      <span class="chevron">â–¾</span>
    </button>

    @if (mostrarFiltroEstado) {
    <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorEstado('todos')">ğŸ—‚ï¸ Todas las tarjetas</div>
      <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">ğŸ”“ Sin asignar</div>
      <div class="opcion" (click)="filtrarPorEstado('en_curso')">â³ En curso</div>
      <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">â­ Pendiente valoraciÃ³n</div>
    </div>
    }
  </div>

  <div class="selector-filtro">
    <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
      @if (uidSeleccionadoNombre) {
      <span class="icono-texto">
        @if (uidSeleccionadoFoto) {
        <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
        }
        {{ uidSeleccionadoNombre }}
      </span>
      } @else {
      <span class="icono-texto"><span class="emoji-icon">ğŸ‘¥</span> Todos</span>
      }
      <span class="chevron">â–¾</span>
    </button>

    @if (mostrarFiltro) {
    <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorUsuario(null)">ğŸ‘¥ Todos</div>

      @for (miembro of miembros; track miembro.uid) {
      <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
        @if (miembro.fotoURL) {
        <img [src]="miembro.fotoURL" alt="avatar" />
        }
        {{ miembro.nombre }}
      </div>
      }
    </div>
    }
  </div>
</div>

@if (miembros$ | async; as miembros) {
<div class="contenedor-tareas">
  <div class="grid-tareas">
    @for (tarea of tareas; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="usuario?.uid || ''" [miembros]="miembros" [delay]="i"
      (asignadoCambio)="reasignarTarea(tarea.id, $event)" (tareaCompletada)="finalizarTarea(tarea)">
    </app-tarjeta-tarea>
    }
  </div>
</div>
}
}
}
}
