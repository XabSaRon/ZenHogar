@if (usuarioSinHogar$ | async) {
<section class="empty-state">
  <div class="empty-hero">
    <div class="emoji">🏡</div>
    <h1>Tu hogar aún no está creado</h1>
    <p class="sub">
      Organiza tareas, reparte responsabilidades y suma puntos con tu familia o piso.
    </p>

    <div class="cta-row">
      <button class="cta cta-primary" (click)="abrirCrearHogar()">
        <span>Crear hogar</span> <small>(recomendado)</small>
      </button>
      <button class="cta" (click)="abrirUnirseHogar()">Unirme con código</button>
      <button class="cta ghost" (click)="probarDemo()">Probar demo</button>
    </div>

    <ul class="benefits">
      <li>🧹 Tareas como tarjetas: asigna, completa y valora</li>
      <li>⭐ Puntos y ranking semanal</li>
      <li>👥 Invita a tu pareja, amigos o familia</li>
    </ul>
  </div>

  <div class="quick-start">
    <h2>Empezar en 3 pasos</h2>
    <ol>
      <li><strong>Crea tu hogar</strong> y ponle un nombre.</li>
      <li><strong>Invita</strong> a quien convivís.</li>
      <li><strong>Añade tareas</strong> o usa una plantilla.</li>
    </ol>

    <div class="cards">
      <div class="qcard">
        <div class="icon">🏠</div>
        <div class="title">Tipos de hogar</div>
        <p>Pareja, Familiar, Erasmus o Amigos. Elige y ¡listo!</p>
      </div>
      <div class="qcard">
        <div class="icon">📨</div>
        <div class="title">Invitaciones</div>
        <p>Invita por email o comparte un código.</p>
      </div>
      <div class="qcard">
        <div class="icon">🛍️</div>
        <div class="title">Tienda de puntos</div>
        <p>Canjea recompensas según la clasificación del hogar.</p>
      </div>
    </div>
  </div>

  <div class="soft-preview">
    <div class="preview-card shimmer">
      <div class="row">
        <div class="bubble"></div>
        <div class="line w60"></div>
      </div>
      <div class="line w100"></div>
      <div class="chips">
        <span class="chip"></span><span class="chip"></span><span class="chip"></span>
      </div>
    </div>
    <div class="preview-card shimmer delay"></div>
    <div class="preview-card shimmer delay2"></div>
  </div>
</section>
} @else {

@if (tareasParaValorar$ | async; as porValorar) {
@if ((porValorar?.length ?? 0) > 0) {
<div class="aviso-valoracion">
  🔔 Tienes {{ porValorar.length }} tarea{{ porValorar.length > 1 ? 's' : '' }}
  pendiente{{ porValorar.length > 1 ? 's' : '' }} de valorar
</div>
}
}

@if (isGuest$ | async) {
@if (miembros$ | async; as miembros) {
<div class="fila-header">
  <div class="info-usuario saludo-card">
    <span class="emoji">👋</span>
    <span class="texto-bienvenida">Bienvenido a ZenHogar</span>
    <span class="pipe">|</span>
    <span class="muted"> — Este es un hogar de ejemplo para que veas cómo funciona.</span>
  </div>

  <div class="selector-filtro">
    <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
      <span class="icono-texto">
        <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
      </span>
      <span class="chevron">▾</span>
    </button>

    @if (mostrarFiltroEstado) {
    <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorEstado('todos')">🗂️ Todas las tarjetas</div>
      <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">🔓 Sin asignar</div>
      <div class="opcion" (click)="filtrarPorEstado('en_curso')">⏳ En curso</div>
      <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">⭐ Pendiente valoración</div>
    </div>
    }
  </div>

  <div class="selector-filtro">
    <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
      @if (uidSeleccionadoNombre) {
      <span class="icono-texto">
        @if (uidSeleccionadoFoto) {
        <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
        }
        {{ uidSeleccionadoNombre }}
      </span>
      } @else {
      <span class="icono-texto"><span class="emoji-icon">👥</span> Todos</span>
      }
      <span class="chevron">▾</span>
    </button>

    @if (mostrarFiltro) {
    <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorUsuario(null)">👥 Todos</div>
      @for (miembro of miembros; track miembro.uid) {
      <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
        @if (miembro.fotoURL) {
        <img [src]="miembro.fotoURL" alt="avatar" />
        }
        {{ miembro.nombre }}
      </div>
      }
    </div>
    }
  </div>
</div>

<div class="contenedor-tareas">
  <div class="grid-tareas">
    @if (tareas$ | async; as tareasDemo) {
    @for (tarea of tareasDemo; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="'guest'" [miembros]="miembros" [delay]="i"
      (asignadoCambio)="invitaALogin()" (penalizarAbandono)="invitaALogin()" (tareaCompletada)="invitaALogin()">
    </app-tarjeta-tarea>
    }
    }
  </div>
</div>
}
} @else {
@if (usuario$ | async; as usuario) {
@if (tareas$ | async; as tareas) {
<div class="fila-header">
  <div class="info-usuario saludo-card">
    <span class="emoji">👋</span>
    <span class="texto-bienvenida">Hola {{ usuario.displayName || usuario.email }}</span>

    @if (tareasAsignadas$ | async; as asignadas) {
    <span class="pipe">|</span>
    <span class="resumen-tareas">
      🧹 {{ asignadas.length }}
      <span class="muted">
        tarea{{ asignadas.length === 1 ? '' : 's' }}
        asignada{{ asignadas.length === 1 ? '' : 's' }}
      </span>
    </span>
    }

    <span class="pipe">|</span>
    <span class="badge-puntos">
      ⭐ <strong>{{ (puntosSemana$ | async) ?? 0 }}</strong> esta semana
    </span>
  </div>

  <app-notificador [uidSolicitante]="(usuario$ | async)?.uid || ''" (verTarea)="onVerTarea($event)">
  </app-notificador>

  <div class="selector-filtro">
    <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
      <span class="icono-texto">
        <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
      </span>
      <span class="chevron">▾</span>
    </button>

    @if (mostrarFiltroEstado) {
    <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorEstado('todos')">🗂️ Todas las tarjetas</div>
      <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">🔓 Sin asignar</div>
      <div class="opcion" (click)="filtrarPorEstado('en_curso')">⏳ En curso</div>
      <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">⭐ Pendiente valoración</div>
    </div>
    }
  </div>

  <div class="selector-filtro">
    <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
      @if (uidSeleccionadoNombre) {
      <span class="icono-texto">
        @if (uidSeleccionadoFoto) {
        <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
        }
        {{ uidSeleccionadoNombre }}
      </span>
      } @else {
      <span class="icono-texto"><span class="emoji-icon">👥</span> Todos</span>
      }
      <span class="chevron">▾</span>
    </button>

    @if (mostrarFiltro) {
    <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
      <div class="opcion" (click)="filtrarPorUsuario(null)">👥 Todos</div>

      @for (miembro of miembros; track miembro.uid) {
      <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
        @if (miembro.fotoURL) {
        <img [src]="miembro.fotoURL" alt="avatar" />
        }
        {{ miembro.nombre }}
      </div>
      }
    </div>
    }
  </div>
</div>

@if (miembros$ | async; as miembros) {
<div class="contenedor-tareas">
  <div class="grid-tareas">
    @for (tarea of tareas; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="usuario?.uid || ''" [miembros]="miembros" [delay]="i"
      [destinatarioNombre]="peticionesPorTareaMap[tarea.id!]?.destinatarioNombre"
      (asignadoCambio)="onAsignadoCambio(tarea, $event)" (penalizarAbandono)="onPenalizarAbandono($event)"
      (tareaCompletada)="onTareaCompletada(tarea)">
    </app-tarjeta-tarea>
    }
  </div>
</div>

<div class="btn-add-wrapper">
  <button mat-fab class="btn-add-tarea" (click)="abrirDialogCrearTarea()" [class.limited]="personalizadasCount >= 2">
    <mat-icon>add</mat-icon>
  </button>
  <div class="label">{{ personalizadasCount }}/2</div>
</div>

}
}
}
}
}
