@if (usuarioSinHogar$ | async) {

<section class="empty-state">
  <div class="empty-hero">
    <div class="emoji">ğŸ¡</div>
    <h1>Tu hogar aÃºn no estÃ¡ creado</h1>
    <p class="sub">
      Organiza tareas, reparte responsabilidades y suma puntos con tu familia o piso.
    </p>

    <div class="cta-row">
      <button class="cta cta-primary" (click)="abrirCrearHogar()">
        <span>Crear hogar</span> <small>(recomendado)</small>
      </button>
      <button class="cta" (click)="abrirUnirseHogar()">Unirme con cÃ³digo</button>
      <button class="cta ghost" (click)="probarDemo()">Probar demo</button>
    </div>

    <ul class="benefits">
      <li>ğŸ§¹ Tareas como tarjetas: asigna, completa y valora</li>
      <li>â­ Puntos y ranking semanal</li>
      <li>ğŸ‘¥ Invita a tu pareja, amigos o familia</li>
    </ul>
  </div>

  <div class="quick-start">
    <h2>Empezar en 3 pasos</h2>
    <ol>
      <li><strong>Crea tu hogar</strong> y ponle un nombre.</li>
      <li><strong>Invita</strong> a quien convivÃ­s.</li>
      <li><strong>AÃ±ade tareas</strong> o usa una plantilla.</li>
    </ol>

    <div class="cards">
      <div class="qcard">
        <div class="icon">ğŸ </div>
        <div class="title">Tipos de hogar</div>
        <p>Pareja, Familiar, Erasmus o Amigos. Elige y Â¡listo!</p>
      </div>
      <div class="qcard">
        <div class="icon">ğŸ“¨</div>
        <div class="title">Invitaciones</div>
        <p>Invita por email o comparte un cÃ³digo.</p>
      </div>
      <div class="qcard">
        <div class="icon">ğŸ›ï¸</div>
        <div class="title">Tienda de puntos</div>
        <p>Canjea recompensas segÃºn la clasificaciÃ³n del hogar.</p>
      </div>
    </div>
  </div>

  <div class="soft-preview">
    <div class="preview-card shimmer">
      <div class="row">
        <div class="bubble"></div>
        <div class="line w60"></div>
      </div>
      <div class="line w100"></div>
      <div class="chips">
        <span class="chip"></span><span class="chip"></span><span class="chip"></span>
      </div>
    </div>
    <div class="preview-card shimmer delay"></div>
    <div class="preview-card shimmer delay2"></div>
  </div>
</section>

} @else {

@if (tareasParaValorar$ | async; as porValorar) {
@if ((porValorar?.length ?? 0) > 0) {
<div class="aviso-valoracion">
  ğŸ”” Tienes {{ porValorar.length }} tarea{{ porValorar.length > 1 ? 's' : '' }}
  pendiente{{ porValorar.length > 1 ? 's' : '' }} de valorar
</div>
}
}

@if (isGuest$ | async) {

@if (miembros$ | async; as miembros) {

<div class="fila-header">
  <div class="fila-left">
    <div class="info-usuario saludo-card">
      <span class="emoji">ğŸ‘‹</span>
      <span class="texto-bienvenida">Bienvenido a ZenHogar</span>
      <span class="pipe">|</span>
      <span class="muted"> â€” Este es un hogar de ejemplo para que veas cÃ³mo funciona.</span>
    </div>
  </div>

  <div class="fila-mid"></div>

  <div class="fila-right">
    <div class="selector-filtro">
      <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
        <span class="icono-texto">
          <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
        </span>
        <span class="chevron">â–¾</span>
      </button>

      @if (mostrarFiltroEstado) {
      <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
        <div class="opcion" (click)="filtrarPorEstado('todos')">ğŸ—‚ï¸ Todas las tarjetas</div>
        <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">ğŸ”“ Sin asignar</div>
        <div class="opcion" (click)="filtrarPorEstado('en_curso')">â³ En curso</div>
        <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">â­ Pendiente valoraciÃ³n</div>
      </div>
      }
    </div>

    <div class="selector-filtro">
      <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
        @if (uidSeleccionadoNombre) {
        <span class="icono-texto">
          @if (uidSeleccionadoFoto) {
          <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
          }
          {{ uidSeleccionadoNombre }}
        </span>
        } @else {
        <span class="icono-texto"><span class="emoji-icon">ğŸ‘¥</span> Todos</span>
        }
        <span class="chevron">â–¾</span>
      </button>

      @if (mostrarFiltro) {
      <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
        <div class="opcion" (click)="filtrarPorUsuario(null)">ğŸ‘¥ Todos</div>
        @for (miembro of miembros; track miembro.uid) {
        <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
          @if (miembro.fotoURL) {
          <img [src]="miembro.fotoURL" alt="avatar" />
          }
          {{ miembro.nombre }}
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<div class="contenedor-tareas">
  <div class="grid-tareas">
    @if (tareas$ | async; as tareasDemo) {
    @for (tarea of tareasDemo; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="'guest'" [miembros]="miembros" [delay]="i"
      (asignadoCambio)="invitaALogin()" (penalizarAbandono)="invitaALogin()" (tareaCompletada)="invitaALogin()">
    </app-tarjeta-tarea>
    }
    }
  </div>
</div>

}

} @else {

@if (usuario$ | async; as usuario) {

<!-- âœ… GUARDIA: evita NG0100 cuando auth â€œparpadeaâ€ y usuario.uid pasa a null -->
@if (usuario?.uid) {

@if (tareas$ | async; as tareas) {

<!-- HEADER -->
<div class="fila-header">
  <div class="fila-left">
    <div class="info-usuario saludo-card">
      <span class="emoji">ğŸ‘‹</span>
      <span class="texto-bienvenida">Hola {{ usuario.displayName || usuario.email }}</span>

      @if (tareasAsignadas$ | async; as asignadas) {
      <span class="pipe">|</span>
      <span class="resumen-tareas">
        ğŸ§¹ {{ asignadas.length }}
        <span class="muted">
          tarea{{ asignadas.length === 1 ? '' : 's' }}
          asignada{{ asignadas.length === 1 ? '' : 's' }}
        </span>
      </span>
      }

      <span class="pipe">|</span>
      <span class="badge-puntos">
        â­ <strong>{{ (puntosSemana$ | async) ?? 0 }}</strong> esta semana
      </span>

      <span class="pipe">|</span>
      <span class="badge-total">
        âœ… <strong>{{ usuario.totalTareasRealizadas ?? 0 }}</strong> tareas totales
      </span>
    </div>
  </div>

  <div class="fila-mid">
    @if (hogar$ | async; as h) {
    @if (h?.id) {
    <app-actividad-hogar class="actividad-inline" [hogarId]="h.id"></app-actividad-hogar>
    }
    }
  </div>

  <div class="fila-right">
    @if (hogar$ | async; as h) {
    @if (h?.id) {
    <app-notificador [hogarId]="h.id" [uidSolicitante]="usuario.uid" (verTarea)="onVerTarea($event)">
    </app-notificador>
    }
    }

    <div class="selector-filtro">
      <button #triggerEstado class="btn-filtro" (click)="toggleFiltroEstado($event)">
        <span class="icono-texto">
          <span class="emoji-icon">{{ estadoIcon }}</span> {{ estadoSeleccionadoLabel }}
        </span>
        <span class="chevron">â–¾</span>
      </button>

      @if (mostrarFiltroEstado) {
      <div #dropdownEstado class="dropdown-filtro" (click)="$event.stopPropagation()">
        <div class="opcion" (click)="filtrarPorEstado('todos')">ğŸ—‚ï¸ Todas las tarjetas</div>
        <div class="opcion" (click)="filtrarPorEstado('sin_asignar')">ğŸ”“ Sin asignar</div>
        <div class="opcion" (click)="filtrarPorEstado('en_curso')">â³ En curso</div>
        <div class="opcion" (click)="filtrarPorEstado('pendiente_valoracion')">â­ Pendiente valoraciÃ³n</div>
      </div>
      }
    </div>

    <div class="selector-filtro">
      <button #trigger class="btn-filtro" (click)="toggleFiltro($event)">
        @if (uidSeleccionadoNombre) {
        <span class="icono-texto">
          @if (uidSeleccionadoFoto) {
          <img [src]="uidSeleccionadoFoto" class="avatar-mini" alt="avatar" />
          }
          {{ uidSeleccionadoNombre }}
        </span>
        } @else {
        <span class="icono-texto"><span class="emoji-icon">ğŸ‘¥</span> Todos</span>
        }
        <span class="chevron">â–¾</span>
      </button>

      @if (mostrarFiltro) {
      <div #dropdown class="dropdown-filtro" (click)="$event.stopPropagation()">
        <div class="opcion" (click)="filtrarPorUsuario(null)">ğŸ‘¥ Todos</div>
        @for (miembro of miembros; track miembro.uid) {
        <div class="opcion" (click)="filtrarPorUsuario(miembro.uid)">
          @if (miembro.fotoURL) {
          <img [src]="miembro.fotoURL" alt="avatar" />
          }
          {{ miembro.nombre }}
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

@if (hogar$ | async; as h) {
@if (miembros$ | async; as miembros) {

<div class="contenedor-tareas">
  <div class="grid-tareas">
    @for (tarea of tareas; track tarea.id; let i = $index) {
    <app-tarjeta-tarea [tarea]="tarea" [uidActual]="usuario.uid" [miembros]="miembros" [delay]="i"
      [adminUid]="h?.adminUid ?? h?.ownerUid ?? null" [destinatarioNombre]="getDestinatarioNombre(tarea.id)"
      (asignadoCambio)="onAsignadoCambio(tarea, $event)" (penalizarAbandono)="onPenalizarAbandono($event)"
      (tareaCompletada)="onTareaCompletada(tarea)">
    </app-tarjeta-tarea>
    }
  </div>
</div>

@if (h?.id) {
<div class="btn-add-wrapper">
  <button mat-fab class="btn-add-tarea" (click)="abrirDialogCrearTarea()" [class.limited]="personalizadasCount >= 2">
    <mat-icon>add</mat-icon>
  </button>
  <div class="label">{{ personalizadasCount }}/2</div>
</div>
}

}
}

}

} @else {
<!-- Si quieres, aquÃ­ puedes poner un mini loader mientras auth estabiliza -->
<!-- <div class="mini-loading">Cargando...</div> -->
}

}

}

}