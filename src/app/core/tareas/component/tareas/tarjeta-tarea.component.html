<div class="tarjeta-tarea" [ngStyle]="styleDelay" [ngClass]="{
    'valoracion-pendiente': tieneValoracionPendiente,
    'tarea-en-curso': !tieneValoracionPendiente && tarea.asignadA && !tarea.completada
  }">
  <div class="tarea-header">
    <div class="emoji-icon">{{ emoji }}</div>
    <h3 class="titulo-tarea">{{ tarea.nombre }}</h3>
  </div>

  <hr class="divider" />

  <div class="asignacion">
    @if (tarea.asignadA) {
    <img class="avatar-small" [src]="tarea.asignadoFotoURL || 'assets/default-avatar.png'" alt="Avatar"
      (error)="onImageError($event)" />
    <span>Asignada a <strong>{{ tarea.asignadoNombre }}</strong></span>
    } @else {
    @if (tieneValoracionPendiente && ultimaPersonaHistorial) {
    <div class="info-ultimo-completador">
      üßπ Realizada por <strong>{{ ultimaPersonaHistorial.nombre }}</strong>
      el {{ ultimaPersonaHistorial.fecha | date: 'dd/MM/yyyy HH:mm' }}
    </div>
    } @else {
    <span class="no-asignada">üîì Sin asignar</span>
    }
    }
  </div>

  <hr class="divider" />

  <div class="boton-asignar">
    <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Asignar tarea"
      [disabled]="tarea.bloqueadaHastaValoracion">
      <mat-icon [fontIcon]="'person_add'"></mat-icon>
    </button>

    @if (tarea.historial?.length) {
    <button mat-icon-button class="historial-btn" (click)="verHistorial()" matTooltip="Ver historial">
      <mat-icon [fontIcon]="'history'"></mat-icon>
    </button>
    }

    @if (tarea.asignadA && !tarea.completada && tarea.asignadA === uidActual) {
    <button class="boton-realizada-lateral" mat-icon-button color="primary" (click)="marcarComoRealizada()"
      matTooltip="Marcar como realizada">
      <mat-icon [fontIcon]="'check_circle'"></mat-icon>
    </button>
    }

    @if (tieneValoracionPendiente && ultimaPersonaHistorial?.uid !== uidActual) {
    <button mat-icon-button class="boton-valorar-lateral boton-realizada-lateral" (click)="abrirDialogoValoracion()"
      matTooltip="Valorar tarea">
      <mat-icon [fontIcon]="'star_rate'"></mat-icon>
    </button>
    }
  </div>

  <mat-menu #menu="matMenu">
    <button mat-menu-item (click)="asignarAMiembro('')" [disabled]="tarea.bloqueadaHastaValoracion">
      <mat-icon [fontIcon]="'lock_open'"></mat-icon>
      <span class="menu-text">Sin asignar</span>
    </button>

    @for (miembro of miembros; track miembro.uid) {
    <button mat-menu-item (click)="asignarAMiembro(miembro.uid)" [disabled]="tarea.bloqueadaHastaValoracion">
      <img class="avatar-small avatar-inline" [src]="miembro.fotoURL || 'assets/default-avatar.png'"
        alt="Avatar de {{ miembro.nombre }}" (error)="onImageError($event)" />
      <span class="menu-text">{{ miembro.nombre }}</span>
    </button>
    }
  </mat-menu>

  @if (tarea.asignadA && !tarea.completada && !tieneValoracionPendiente) {
  <div class="hover-loader">
    ‚è≥ En curso
  </div>
  }

  @if (tieneValoracionPendiente) {
  <div class="hover-loader">‚≠ê Pendiente de valorar</div>
  }

</div>