<div class="tarjeta-tarea" [ngStyle]="styleDelay" [ngClass]="{
    'valoracion-pendiente': tieneValoracionPendiente,
    'tarea-en-curso': isEnCurso
  }">
  <div class="tarea-header">
    <div class="emoji-icon">{{ emoji }}</div>
    <h3 class="titulo-tarea">{{ tarea.nombre }}</h3>

    @if (peticionPendiente || peticionParaMi) {
    <span class="peticion-campana-wrapper">
      <button class="peticion-campana" mat-icon-button (click)="onClickCampana($event)"
        [ngClass]="{ 'es-mia': !!peticionParaMi }" aria-label="Petici√≥n de asignaci√≥n" [matTooltip]="peticionParaMi
        ? 'Tienes una petici√≥n de asignaci√≥n'
        : ('Pendiente de aceptaci√≥n por ' + (destinatarioNombre || 'usuario'))" matTooltipPosition="above"
        matTooltipShowDelay="250" matTooltipHideDelay="0" [matTooltipDisabled]="tooltipDisabled"
        (mousedown)="tooltipDisabled = true" (mouseup)="tooltipDisabled = false" (mouseleave)="tooltipDisabled = false">
        <mat-icon>{{ peticionParaMi ? 'notifications_active' : 'notifications' }}</mat-icon>
      </button>
    </span>
    }

  </div>

  <hr class="divider" />

  <div class="asignacion">
    @if (tarea.asignadA) {
    <img class="avatar-small" [src]="tarea.asignadoFotoURL || 'assets/default-avatar.png'" alt="Avatar"
      (error)="onImageError($event)" />
    <span>Asignada a <strong>{{ tarea.asignadoNombre }}</strong></span>
    } @else {
    @if (tieneValoracionPendiente && ultimaPersonaHistorial) {
    <div class="info-ultimo-completador">
      üßπ Realizada por <strong>{{ ultimaPersonaHistorial.nombre }}</strong>
      el {{ ultimaPersonaHistorial.fecha | date: 'dd/MM/yyyy HH:mm' }}
    </div>
    } @else {
    <span class="no-asignada">üîì Sin asignar</span>
    }
    }
  </div>

  <hr class="divider" />

  <div class="boton-asignar">
    <button mat-icon-button [matMenuTriggerFor]="menu"
      [matTooltip]="peticionPendiente ? 'Bloqueada: hay una petici√≥n pendiente' : tooltipAsignacion"
      [disabled]="!puedeAbrirMenu || peticionPendiente">
      <mat-icon [fontIcon]="'person_add'"></mat-icon>
    </button>

    @if (tarea.historial?.length) {
    <button mat-icon-button class="historial-btn" (click)="verHistorial()" matTooltip="Ver historial">
      <mat-icon [fontIcon]="'history'"></mat-icon>
    </button>
    }

    @if (isEnCurso && tarea.asignadA === uidActual) {
    <button class="boton-realizada-lateral" mat-icon-button color="primary" (click)="marcarComoRealizada()"
      matTooltip="Marcar como realizada">
      <mat-icon [fontIcon]="'check_circle'"></mat-icon>
    </button>
    }

    @if (tieneValoracionPendiente && ultimaPersonaHistorial?.uid !== uidActual) {
    <button mat-icon-button class="boton-valorar-lateral boton-realizada-lateral" (click)="abrirDialogoValoracion()"
      matTooltip="Valorar tarea">
      <mat-icon [fontIcon]="'star_rate'"></mat-icon>
    </button>
    }
  </div>

  <mat-menu #menu="matMenu">
    <button mat-menu-item (click)="asignarAMiembro('')" [disabled]="!puedeGestionarAsignacion">
      <span class="mdc-list-item__primary-text item-row">
        <mat-icon fontIcon="lock_open" class="item-ico"></mat-icon>
        <span>Sin asignar</span>
      </span>
    </button>

    @for (miembro of miembros; track miembro.uid) {
    <button mat-menu-item (click)="asignarAMiembro(miembro.uid)" [disabled]="!puedeGestionarAsignacion">
      <span class="mdc-list-item__primary-text item-row">
        <img class="avatar-inline item-ico" [src]="miembro.fotoURL || 'assets/default-avatar.png'"
          alt="Avatar de {{ miembro.nombre }}" (error)="onImageError($event)" />
        <span>{{ miembro.nombre }}</span>
      </span>
    </button>
    }
  </mat-menu>

  @if (isEnCurso) {
  <div class="hover-loader">‚è≥ En curso</div>
  }
  @if (tieneValoracionPendiente) {
  <div class="hover-loader">‚≠ê Pendiente de valorar</div>
  }
</div>